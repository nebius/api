syntax = "proto3";

package nebius.ai.v1;

import "buf/validate/validate.proto";
import "google/protobuf/duration.proto";
import "nebius/annotations.proto";
import "nebius/common/v1/metadata.proto";
import "nebius/compute/v1/disk.proto";
import "nebius/compute/v1/instance.proto";

option go_package = "github.com/nebius/gosdk/proto/nebius/ai/v1";
option java_multiple_files = true;
option java_outer_classname = "JobProto";
option java_package = "ai.nebius.pub.ai.v1";

// Represents a job with a specified workload.
message Job {
  common.v1.ResourceMetadata metadata = 1 [(buf.validate.field).required = true];

  JobSpec spec = 2 [(buf.validate.field).required = true];

  JobStatus status = 3 [(field_behavior) = OUTPUT_ONLY];
}

// JobSpec defines a job that will be run.
message JobSpec {
  // The Docker image to use for the job's container.
  string image = 1 [(buf.validate.field).required = true];

  // Specifies the environment variables for the job's container.
  repeated EnvironmentVariable environment_variables = 2;

  // Specifies the ports that the job exposes.
  repeated Port ports = 3;

  // The entrypoint command for the job's container.
  string container_command = 4;

  // The arguments to pass to the entrypoint command.
  string args = 5;

  // The working directory for the job's container.
  string working_dir = 6 [(buf.validate.field) = {
    string: {max_len: 128}
  }];

  // Volumes to be mounted into the job's container.
  repeated VolumeMount volumes = 7;

  // Registry credentials for private Docker registry.
  RegistryCredentials registry_credentials = 10;

  // Compute platform that the job will be run on.
  string platform = 20 [(buf.validate.field).required = true];

  // Compute preset that the job will be run on.
  string preset = 21 [(buf.validate.field).required = true];

  // Shared memory size in bytes for the job's container.
  int64 shm_size_bytes = 22 [(buf.validate.field) = {
    int64: {gte: 0}
  }];

  // Disk spec for the main disk of the job.
  DiskSpec disk = 23 [(buf.validate.field).required = true];

  // Subnet ID where the job will be deployed.
  string subnet_id = 24 [
    (buf.validate.field).required = true,
    (nid) = {
      resource: ["vpcsubnet"]
    }
  ];

  // Whether to assign a public IP to the job.
  bool public_ip = 25;

  // Public keys to be authorized for SSH access to the job.
  repeated string ssh_authorized_keys = 26;

  // Restart attempts for the job.
  int64 restart_attempts = 30 [(buf.validate.field) = {
    int64: {gte: -1}
  }];

  // Job timeout.
  google.protobuf.Duration timeout = 31;

  // EnvironmentVariable defines an environment variable for the endpoint's container.
  message EnvironmentVariable {
    // The name of the environment variable.
    string name = 1 [(buf.validate.field).required = true];

    // Environment variable value.
    string value = 2 [(sensitive) = true];
  }

  message Port {
    // Container port.
    int32 container_port = 1 [(buf.validate.field) = {
      int32: {
        lte: 65535
        gte: 1
      }
    }];

    // Host port.
    //
    // If not specified, will be same as container_port.
    int32 host_port = 2 [(buf.validate.field) = {
      int32: {
        lte: 65535
        gte: 0
      }
    }];

    // Port's protocol.
    Protocol protocol = 3 [(buf.validate.field).required = true];

    // Represents protocol of the job's port which will be exposed.
    enum Protocol {
      PROTOCOL_UNSPECIFIED = 0;

      // HTTP protocol.
      HTTP = 1;

      // TCP protocol.
      TCP = 2;

      // UDP protocol.
      UDP = 3;
    }
  }

  // VolumeMount represents a volume mount for the endpoint's container.
  message VolumeMount {
    // Source of the volume mount.
    //
    // Can be a name of an ID of Nebius Storage bucket or filesystem.
    string source = 1 [(nid) = {
      resource: [
        "computefilesystem",
        "storagebucket"
      ]
    }];

    // Path inside the source volume.
    //
    // Optional.
    string source_path = 2;

    // Path inside the endpoint's container where the volume is mounted.
    //
    // Must be an absolute path.
    string container_path = 3;

    // Mount mode.
    Mode mode = 4 [(buf.validate.field).required = true];

    // Mode that will be used to mount the volume.
    enum Mode {
      MODE_UNSPECIFIED = 0;

      // Read-write mode.
      READ_WRITE = 1;

      // Read-only mode.
      READ_ONLY = 2;
    }
  }

  message DiskSpec {
    // Disk type.
    nebius.compute.v1.DiskSpec.DiskType type = 1 [(buf.validate.field).required = true];

    // Disk size in bytes.
    int64 size_bytes = 2;
  }

  message RegistryCredentials {
    // Registry username for private Docker registry.
    string username = 1;

    // Registry password for private Docker registry.
    string password = 2 [(sensitive) = true];

    // Secret version storing the registry credentials.
    // Must have keys "REGISTRY_USERNAME" and "REGISTRY_PASSWORD".
    string mysterybox_secret_version = 3;
  }
}

// JobStatus represents the status of a VM app.
message JobStatus {
  // Private endpoints to access the workload.
  repeated string private_endpoints = 1;

  // Public endpoints to access the workload.
  repeated string public_endpoints = 2;

  // Status of individual job instances.
  repeated JobInstanceStatus instances = 10;

  // State of the job.
  State state = 20;

  // Details of the job's state.
  JobStateDetails state_details = 21;

  // Job state.
  enum State {
    STATE_UNSPECIFIED = 0;

    // The job is creating resources.
    PROVISIONING = 1;

    // The job is being started.
    STARTING = 2;

    // The job is running.
    RUNNING = 3;

    // The job is being cancelled.
    CANCELLING = 4;

    // The job is being deleted.
    DELETING = 5;

    // The job has successfully completed.
    COMPLETED = 6;

    // The job has failed.
    FAILED = 7;

    // The job has been cancelled.
    CANCELLED = 8;

    // The job encountered an internal error.
    ERROR = 9;
  }
}

// Job state details.
message JobStateDetails {
  // Short state description.
  string code = 1 [(buf.validate.field).required = true];

  // Detailed human-readable description.
  string message = 2;
}

// JobInstanceStatus represents the status of a job instance.
message JobInstanceStatus {
  // The current state of the job's workload.
  State state = 1 [(buf.validate.field).required = true];

  // ID of the compute instance running the job.
  string compute_instance_id = 10 [(nid) = {
    resource: ["computeinstance"]
  }];

  // The current state of the compute instance.
  nebius.compute.v1.InstanceStatus.InstanceState compute_instance_state = 11 [(buf.validate.field).required = true];

  // Private IP address of the instance.
  string private_ip = 12;

  // Public IP address of the instance.
  string public_ip = 13;

  // Job instance state.
  enum State {
    STATE_UNSPECIFIED = 0;

    // The job is creating resources.
    PROVISIONING = 1;

    // The job is being started.
    STARTING = 2;

    // The job is running.
    RUNNING = 3;

    // The job is completing.
    COMPLETING = 4;

    // The job is being cancelled.
    CANCELLING = 5;

    // The job is being deleted.
    DELETING = 6;

    // The job has successfully completed.
    COMPLETED = 7;

    // The job has failed.
    FAILED = 8;

    // The job has been cancelled.
    CANCELLED = 9;

    // The job encountered an internal error.
    ERROR = 10;
  }
}
