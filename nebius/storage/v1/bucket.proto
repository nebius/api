syntax = "proto3";

package nebius.storage.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "nebius/annotations.proto";
import "nebius/common/v1/metadata.proto";
import "nebius/storage/v1/base.proto";
import "nebius/storage/v1/bucket_counters.proto";
import "nebius/storage/v1/bucket_policy.proto";
import "nebius/storage/v1/cors.proto";
import "nebius/storage/v1/lifecycle.proto";

option go_package = "github.com/nebius/gosdk/proto/nebius/storage/v1";
option java_multiple_files = true;
option java_outer_classname = "BucketProto";
option java_package = "ai.nebius.pub.storage.v1";

message Bucket {
  option (resource_behavior) = IMMUTABLE_NAME;

  common.v1.ResourceMetadata metadata = 1 [(buf.validate.field).required = true];

  BucketSpec spec = 2 [(buf.validate.field).required = true];

  BucketStatus status = 3 [(field_behavior) = OUTPUT_ONLY];
}

message BucketSpec {
  // Supports transitions:
  //  * disabled -> enabled
  //  * disabled -> suspended
  //  * enabled <-> suspended
  VersioningPolicy versioning_policy = 2 [(field_behavior) = NON_EMPTY_DEFAULT];

  // Maximum bucket size.
  // Zero means unlimited.
  // Actual limit can be lower if customer doesn't have enough quota.
  // Real bucket size can go a little higher if customer writes too fast.
  int64 max_size_bytes = 4;

  LifecycleConfiguration lifecycle_configuration = 5;

  // Cross-origin resource sharing configuration.
  CORSConfiguration cors = 8;

  // Storage class to use by default for uploads to the bucket. It may be overridden by `x-amz-storage-class` header.
  // If not set - STANDARD is used as a default storage class.
  StorageClass default_storage_class = 9;

  // Storage class to override any other storage class of uploading objects. It overrides the storage class regardless
  // of how the original storage class was specified - either the default storage class
  // or the one provided via the `x-amz-storage-class` header.
  StorageClass override_storage_class = 10 [
    deprecated = true,
    (field_deprecation_details) = {
      effective_at: "2025-12-01"
      description: "Use `default_storage_class` with `force_storage_class` instead"
    }
  ];

  // Flag to force usage of default_storage_class, ignoring `x-amz-storage-class` header.
  bool force_storage_class = 11;

  // Object audit logging specifies which requests must be logged - none, all or mutational only.
  ObjectAuditLogging object_audit_logging = 12;

  enum ObjectAuditLogging {
    OBJECT_AUDIT_LOGGING_UNSPECIFIED = 0;

    // Logging is disabled.
    NONE = 1;

    // Logging enabled only for mutating requests.
    MUTATE_ONLY = 2;

    // Logging enabled for all requests.
    ALL = 3;
  }

  // Bucket policy specifies granular permissions for a bucket.
  BucketPolicy bucket_policy = 13;
}

message BucketStatus {
  repeated BucketCounters counters = 1;

  enum State {
    STATE_UNSPECIFIED = 0;

    // Bucket is under creation and cannot be used yet.
    CREATING = 1;

    // Bucket is active and ready for usage.
    ACTIVE = 2;

    // Bucket is being updated.
    // It can be used, but some settings are being modified and you can observe their inconsistency.
    UPDATING = 3;

    // Bucket is scheduled for deletion.
    // It cannot be used in s3 api anymore.
    SCHEDULED_FOR_DELETION = 4;
  }

  State state = 2;

  enum SuspensionState {
    SUSPENSION_STATE_UNSPECIFIED = 0;

    NOT_SUSPENDED = 1;

    SUSPENDED = 2;
  }

  SuspensionState suspension_state = 3;

  // The time when the bucket was deleted (or scheduled for deletion).
  // It resets to null if the bucket is undeleted.
  google.protobuf.Timestamp deleted_at = 4;

  // The time when the bucket will be automatically purged in case it was soft-deleted.
  google.protobuf.Timestamp purge_at = 5;

  // The domain of the endpoint where the bucket can be accessed. It omits the scheme (HTTPS) and the port (443)
  // and contains only the FQDN address.
  string domain_name = 6;

  // The name of the region where the bucket is located for use with S3 clients, i.e. "eu-west1".
  string region = 8;
}
